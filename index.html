<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="screen-orientation" content="landscape">
<title>éº»å°‡è¨ˆåˆ†</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body {
    width: 100%; height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #1a1a2e;
    color: #eee;
    overflow: hidden;
    user-select: none;
  }
  @media screen and (orientation: portrait) {
    .rotate-hint { display: flex !important; }
    .app { display: none !important; }
  }
  .rotate-hint {
    display: none;
    position: fixed; inset: 0;
    background: #1a1a2e;
    align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
    font-size: 20px; color: #aaa; z-index: 9999;
  }
  .rotate-hint .icon { font-size: 48px; animation: rotate-anim 2s ease-in-out infinite; }
  @keyframes rotate-anim { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(90deg)} }

  .app { width: 100%; height: 100%; display: flex; flex-direction: column; }

  /* ===== Setup Screen ===== */
  .screen { display: none; width: 100%; height: 100%; }
  .screen.active { display: flex; }

  #setup-screen {
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
    padding: 16px 24px;
  }
  #setup-screen h1 {
    font-size: 22px;
    color: #e94560;
    margin-bottom: 2px;
    letter-spacing: 4px;
  }
  .setup-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
  }
  .setup-row label { width: 60px; text-align: right; color: #aaa; flex-shrink: 0; }
  .setup-row input {
    width: 100px;
    padding: 6px 10px;
    border: 1px solid #333;
    border-radius: 8px;
    background: #16213e;
    color: #fff;
    font-size: 14px;
    text-align: center;
    outline: none;
  }
  .setup-row input:focus { border-color: #e94560; }
  .player-inputs {
    display: flex; gap: 14px; flex-wrap: wrap; justify-content: center;
  }
  .player-setup {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }
  .avatar-upload {
    width: 62px; height: 62px;
    border-radius: 50%;
    border: 2px dashed #555;
    background: #0f3460;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    overflow: hidden;
    flex-shrink: 0;
    transition: border-color .2s;
  }
  .avatar-upload:active { border-color: #e94560; transform: scale(0.95); }
  .avatar-upload img { width: 100%; height: 100%; object-fit: cover; }
  .player-inputs input {
    width: 80px;
    padding: 6px 8px;
    border: 2px solid #333;
    border-radius: 10px;
    background: #16213e;
    color: #fff;
    font-size: 13px;
    text-align: center;
    outline: none;
  }
  .player-inputs input:focus { border-color: #e94560; }
  .btn {
    padding: 10px 32px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all .15s;
    letter-spacing: 2px;
  }
  .btn:active { transform: scale(0.95); }
  .btn-primary { background: #e94560; color: #fff; }
  .btn-primary:active { background: #c73650; }
  .btn-secondary { background: #16213e; color: #ccc; border: 1px solid #444; }
  .btn-secondary:active { background: #1a2a4a; }

  /* ===== Game Screen ===== */
  #game-screen {
    flex-direction: column;
    height: 100%;
  }
  .scoreboard {
    display: flex;
    flex: 1;
    gap: 6px;
    padding: 8px 8px 0;
  }
  .player-card {
    flex: 1;
    background: #16213e;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    position: relative;
    border: 2px solid transparent;
    transition: border-color .2s;
  }
  .player-card.positive { border-color: #2ecc71; }
  .player-card.negative { border-color: #e74c3c; }
  .player-card .name {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 2px;
  }
  .player-card .score {
    font-size: 32px;
    font-weight: 800;
  }
  .player-card .score.pos { color: #2ecc71; }
  .player-card .score.neg { color: #e74c3c; }
  .player-card .score.zero { color: #888; }
  .player-card .rank {
    position: absolute;
    top: 6px; left: 10px;
    font-size: 11px;
    color: #666;
    font-weight: 600;
  }
  .player-card .avatar {
    width: 48px; height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #333;
    flex-shrink: 0;
  }
  .player-card .avatar-placeholder {
    width: 48px; height: 48px;
    border-radius: 50%;
    background: #0f3460;
    border: 2px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }

  .toolbar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 8px;
  }
  .toolbar .btn { padding: 10px 24px; font-size: 15px; }

  /* ===== Modal ===== */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: #16213e;
    border-radius: 18px;
    padding: 20px 24px;
    min-width: 360px;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
  }
  .modal h2 {
    font-size: 18px;
    letter-spacing: 2px;
    color: #e94560;
  }
  .modal-btns {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .modal-btns .btn { min-width: 100px; font-size: 15px; padding: 10px 20px; }
  .modal-btns .btn.selected { background: #e94560; color: #fff; border-color: #e94560; }

  .tai-control {
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 24px;
    font-weight: 700;
  }
  .tai-control .btn {
    width: 44px; height: 44px;
    padding: 0;
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }
  .tai-val { min-width: 40px; text-align: center; }

  .calc-preview {
    font-size: 13px;
    color: #aaa;
    text-align: center;
    min-height: 18px;
  }

  /* History */
  #history-screen {
    flex-direction: column;
    height: 100%;
    padding: 10px;
  }
  #history-screen h2 { text-align: center; color: #e94560; margin-bottom: 8px; letter-spacing: 2px; }
  .history-list {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .history-item {
    background: #16213e;
    border-radius: 10px;
    padding: 8px 14px;
    margin-bottom: 6px;
    font-size: 13px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .history-item .desc { flex: 1; }
  .history-item .undo-btn {
    background: none; border: 1px solid #e94560; color: #e94560;
    border-radius: 6px; padding: 4px 10px; font-size: 12px; cursor: pointer;
  }
  .history-back { margin-top: 8px; align-self: center; }

  /* ===== Cropper ===== */
  #crop-modal .modal { gap: 10px; padding: 16px 20px; }
  .crop-container {
    width: 220px; height: 220px;
    border-radius: 50%;
    overflow: hidden;
    background: #111;
    border: 3px solid #e94560;
    position: relative;
    touch-action: none;
    cursor: grab;
    flex-shrink: 0;
  }
  .crop-container:active { cursor: grabbing; }
  #crop-img {
    position: absolute;
    top: 0; left: 0;
    transform-origin: 0 0;
    pointer-events: none;
    display: block;
    max-width: none; max-height: none;
  }
  .crop-hint { font-size: 12px; color: #666; text-align: center; }
  .crop-zoom-row {
    display: flex; align-items: center; gap: 14px;
  }
  .crop-zoom-row .btn {
    width: 38px; height: 38px; padding: 0;
    border-radius: 50%; font-size: 22px;
    display: flex; align-items: center; justify-content: center;
  }
</style>
</head>
<body>
<div class="rotate-hint">
  <div class="icon">ğŸ“±</div>
  <div>è«‹æ©«å‘ä½¿ç”¨æ‰‹æ©Ÿ</div>
</div>

<div class="app">
  <!-- Setup Screen -->
  <div id="setup-screen" class="screen active">
    <h1>ğŸ€„ éº»å°‡è¨ˆåˆ†</h1>
    <div class="player-inputs">
      <div class="player-setup">
        <div class="avatar-upload" id="av0" onclick="pickPhoto(0)"><span id="av0-icon">ğŸ‘¤</span></div>
        <input type="text" id="p1" placeholder="ç©å®¶1" maxlength="6">
      </div>
      <div class="player-setup">
        <div class="avatar-upload" id="av1" onclick="pickPhoto(1)"><span id="av1-icon">ğŸ‘¤</span></div>
        <input type="text" id="p2" placeholder="ç©å®¶2" maxlength="6">
      </div>
      <div class="player-setup">
        <div class="avatar-upload" id="av2" onclick="pickPhoto(2)"><span id="av2-icon">ğŸ‘¤</span></div>
        <input type="text" id="p3" placeholder="ç©å®¶3" maxlength="6">
      </div>
      <div class="player-setup">
        <div class="avatar-upload" id="av3" onclick="pickPhoto(3)"><span id="av3-icon">ğŸ‘¤</span></div>
        <input type="text" id="p4" placeholder="ç©å®¶4" maxlength="6">
      </div>
    </div>
    <!-- hidden file inputs -->
    <input type="file" id="file0" accept="image/*" style="display:none" onchange="onPhoto(0,this)">
    <input type="file" id="file1" accept="image/*" style="display:none" onchange="onPhoto(1,this)">
    <input type="file" id="file2" accept="image/*" style="display:none" onchange="onPhoto(2,this)">
    <input type="file" id="file3" accept="image/*" style="display:none" onchange="onPhoto(3,this)">
    <div style="display:flex;gap:16px">
      <div class="setup-row">
        <label>åº•</label>
        <input type="number" id="base-price" value="30" min="0">
      </div>
      <div class="setup-row">
        <label>ä¸€å°</label>
        <input type="number" id="tai-price" value="10" min="0">
      </div>
    </div>
    <button class="btn btn-primary" onclick="startGame()">é–‹å§‹</button>
  </div>

  <!-- Game Screen -->
  <div id="game-screen" class="screen">
    <div class="scoreboard" id="scoreboard"></div>
    <div class="toolbar">
      <button class="btn btn-primary" onclick="openScoring()">è¨ˆåˆ†</button>
      <button class="btn btn-secondary" onclick="showHistory()">ç´€éŒ„</button>
      <button class="btn btn-secondary" onclick="resetGame()">é‡ç½®</button>
    </div>
  </div>

  <!-- History Screen -->
  <div id="history-screen" class="screen">
    <h2>è¨ˆåˆ†ç´€éŒ„</h2>
    <div class="history-list" id="history-list"></div>
    <button class="btn btn-secondary history-back" onclick="showScreen('game-screen')">è¿”å›</button>
  </div>
</div>

<!-- Scoring Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal" id="modal-content"></div>
</div>

<!-- Crop Modal -->
<div class="modal-overlay" id="crop-modal">
  <div class="modal">
    <h2>é¸æ“‡åœ“å½¢å€åŸŸ</h2>
    <div class="crop-container" id="crop-container">
      <img id="crop-img" alt="">
    </div>
    <p class="crop-hint">æ‹–æ›³ç§»å‹• Â· é›™æŒ‡ç¸®æ”¾</p>
    <div class="crop-zoom-row">
      <button class="btn btn-secondary" onclick="cropZoom(-0.15)">âˆ’</button>
      <span style="font-size:13px;color:#aaa">ç¸®æ”¾</span>
      <button class="btn btn-secondary" onclick="cropZoom(0.15)">+</button>
    </div>
    <div class="modal-btns">
      <button class="btn btn-primary" onclick="confirmCrop()">ç¢ºèª</button>
      <button class="btn btn-secondary" onclick="cancelCrop()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
const state = {
  players: [],
  photos: [null, null, null, null],
  scores: [0, 0, 0, 0],
  base: 30,
  tai: 10,
  history: []
};

// --- Photo upload ---
function pickPhoto(i) {
  document.getElementById('file' + i).click();
}

function onPhoto(i, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => openCropper(i, e.target.result);
  reader.readAsDataURL(file);
  input.value = ''; // allow re-selecting same file
}

// --- Screen management ---
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// --- Setup ---
function startGame() {
  const names = [
    document.getElementById('p1').value.trim() || 'ç©å®¶1',
    document.getElementById('p2').value.trim() || 'ç©å®¶2',
    document.getElementById('p3').value.trim() || 'ç©å®¶3',
    document.getElementById('p4').value.trim() || 'ç©å®¶4',
  ];
  state.players = names;
  // photos already set by onPhoto, keep them
  state.scores = [0, 0, 0, 0];
  state.history = [];
  state.base = parseInt(document.getElementById('base-price').value) || 30;
  state.tai = parseInt(document.getElementById('tai-price').value) || 10;
  renderScoreboard();
  showScreen('game-screen');
}

function resetGame() {
  if (!confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰åˆ†æ•¸ï¼Ÿ')) return;
  state.scores = [0, 0, 0, 0];
  state.history = [];
  renderScoreboard();
}

// --- Scoreboard ---
function renderScoreboard() {
  const sb = document.getElementById('scoreboard');
  // Calculate ranks
  const sorted = state.scores.map((s, i) => ({ s, i })).sort((a, b) => b.s - a.s);
  const ranks = [0, 0, 0, 0];
  sorted.forEach((item, idx) => { ranks[item.i] = idx + 1; });

  sb.innerHTML = state.players.map((name, i) => {
    const s = state.scores[i];
    const cls = s > 0 ? 'positive' : s < 0 ? 'negative' : '';
    const scls = s > 0 ? 'pos' : s < 0 ? 'neg' : 'zero';
    const prefix = s > 0 ? '+' : '';
    const avatarHtml = state.photos[i]
      ? `<img class="avatar" src="${state.photos[i]}" alt="">`
      : `<div class="avatar-placeholder">ğŸ‘¤</div>`;
    return `<div class="player-card ${cls}">
      <span class="rank">#${ranks[i]}</span>
      ${avatarHtml}
      <span class="name">${esc(name)}</span>
      <span class="score ${scls}">${prefix}${s}</span>
    </div>`;
  }).join('');
}

// --- Scoring flow ---
let scoring = {};

function openScoring() {
  scoring = { type: null, winner: null, loser: null, taiCount: 0, multiplier: 1 };
  stepChooseType();
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
}

function showModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal').classList.add('active');
}

function stepChooseType() {
  showModal(`
    <h2>èƒ¡ç‰Œæ–¹å¼</h2>
    <div class="modal-btns">
      <button class="btn btn-primary" onclick="scoring.type='è‡ªæ‘¸';stepChooseWinner()">è‡ªæ‘¸</button>
      <button class="btn btn-primary" onclick="scoring.type='æ”¾æ§';stepChooseWinner()">æ”¾æ§</button>
    </div>
    <button class="btn btn-secondary" onclick="closeModal()" style="margin-top:4px">å–æ¶ˆ</button>
  `);
}

function stepChooseWinner() {
  const btns = state.players.map((name, i) =>
    `<button class="btn btn-secondary" onclick="scoring.winner=${i};${scoring.type === 'æ”¾æ§' ? 'stepChooseLoser()' : 'stepChooseTai()'}">${esc(name)}</button>`
  ).join('');
  showModal(`
    <h2>èª°èƒ¡ç‰Œï¼Ÿ</h2>
    <div class="modal-btns">${btns}</div>
    <button class="btn btn-secondary" onclick="stepChooseType()" style="margin-top:4px">ä¸Šä¸€æ­¥</button>
  `);
}

function stepChooseLoser() {
  const btns = state.players.map((name, i) => {
    if (i === scoring.winner) return '';
    return `<button class="btn btn-secondary" onclick="scoring.loser=${i};stepChooseTai()">${esc(name)}</button>`;
  }).join('');
  showModal(`
    <h2>èª°æ”¾æ§ï¼Ÿ</h2>
    <div class="modal-btns">${btns}</div>
    <button class="btn btn-secondary" onclick="stepChooseWinner()" style="margin-top:4px">ä¸Šä¸€æ­¥</button>
  `);
}

function stepChooseTai() {
  scoring.taiCount = 0;
  renderTaiStep();
}

function renderTaiStep() {
  const amount = state.base + state.tai * scoring.taiCount;
  let preview = '';
  if (scoring.type === 'è‡ªæ‘¸') {
    const total = amount * 3;
    preview = `æ¯å®¶ä»˜ ${amount}ï¼Œå…±æ”¶ ${total}`;
  } else {
    preview = `${esc(state.players[scoring.loser])} ä»˜ ${amount}`;
  }
  showModal(`
    <h2>å¹¾å°ï¼Ÿ</h2>
    <div class="tai-control">
      <button class="btn btn-secondary" onclick="changeTai(-1)">âˆ’</button>
      <span class="tai-val" id="tai-display">${scoring.taiCount}</span>
      <button class="btn btn-secondary" onclick="changeTai(1)">+</button>
    </div>
    <div class="calc-preview">${preview}</div>
    <div class="modal-btns">
      <button class="btn btn-primary" onclick="stepChooseMultiplier()">ä¸‹ä¸€æ­¥</button>
      <button class="btn btn-secondary" onclick="${scoring.type === 'æ”¾æ§' ? 'stepChooseLoser()' : 'stepChooseWinner()'}">ä¸Šä¸€æ­¥</button>
    </div>
  `);
}

function changeTai(d) {
  scoring.taiCount = Math.max(0, scoring.taiCount + d);
  renderTaiStep();
}

function stepChooseMultiplier() {
  scoring.multiplier = 1;
  renderMultiplierStep();
}

function renderMultiplierStep() {
  const amount = state.base + state.tai * scoring.taiCount;
  const finalAmount = amount * scoring.multiplier;
  let preview = '';
  if (scoring.type === 'è‡ªæ‘¸') {
    preview = `æ¯å®¶ä»˜ ${finalAmount}ï¼Œå…±æ”¶ ${finalAmount * 3}`;
  } else {
    preview = `${esc(state.players[scoring.loser])} ä»˜ ${finalAmount}`;
  }
  const mulLabel = scoring.multiplier + 'x';
  showModal(`
    <h2>å€ç‡</h2>
    <div class="tai-control">
      <button class="btn btn-secondary" onclick="changeMultiplier(-1)">âˆ’</button>
      <span class="tai-val">${mulLabel}</span>
      <button class="btn btn-secondary" onclick="changeMultiplier(1)">+</button>
    </div>
    <div class="calc-preview">(${state.base} + ${state.tai}Ã—${scoring.taiCount}) Ã— ${scoring.multiplier} = ${finalAmount}</div>
    <div class="calc-preview">${preview}</div>
    <div class="modal-btns">
      <button class="btn btn-primary" onclick="confirmScore()">ç¢ºèª</button>
      <button class="btn btn-secondary" onclick="renderTaiStep()">ä¸Šä¸€æ­¥</button>
    </div>
  `);
}

function changeMultiplier(d) {
  scoring.multiplier = Math.max(1, scoring.multiplier + d);
  renderMultiplierStep();
}

function confirmScore() {
  const baseAmount = state.base + state.tai * scoring.taiCount;
  const amount = baseAmount * scoring.multiplier;
  const mul = scoring.multiplier;
  const w = scoring.winner;
  const prev = [...state.scores];
  let desc = '';
  const mulTag = mul > 1 ? ` Ã—${mul}` : '';

  if (scoring.type === 'è‡ªæ‘¸') {
    for (let i = 0; i < 4; i++) {
      if (i === w) {
        state.scores[i] += amount * 3;
      } else {
        state.scores[i] -= amount;
      }
    }
    desc = `${state.players[w]} è‡ªæ‘¸ ${scoring.taiCount}å°${mulTag} (+${amount * 3})`;
  } else {
    const l = scoring.loser;
    state.scores[w] += amount;
    state.scores[l] -= amount;
    desc = `${state.players[w]} èƒ¡ ${state.players[l]} ${scoring.taiCount}å°${mulTag} (+${amount})`;
  }

  state.history.push({ desc, prev, after: [...state.scores] });
  renderScoreboard();
  closeModal();
}

// --- History ---
function showHistory() {
  const list = document.getElementById('history-list');
  if (state.history.length === 0) {
    list.innerHTML = '<div style="text-align:center;color:#666;padding:20px">å°šç„¡ç´€éŒ„</div>';
  } else {
    list.innerHTML = state.history.map((h, i) => `
      <div class="history-item">
        <span class="desc">${i + 1}. ${esc(h.desc)}</span>
        <button class="undo-btn" onclick="undoTo(${i})">æ’¤éŠ·</button>
      </div>
    `).reverse().join('');
  }
  showScreen('history-screen');
}

function undoTo(idx) {
  if (!confirm(`ç¢ºå®šæ’¤éŠ·ã€Œ${state.history[idx].desc}ã€ï¼Ÿï¼ˆæ­¤ç­†ä¹‹å¾Œçš„ç´€éŒ„ä¹Ÿæœƒä¸€ä½µæ’¤éŠ·ï¼‰`)) return;
  state.scores = [...state.history[idx].prev];
  state.history = state.history.slice(0, idx);
  renderScoreboard();
  showHistory();
}

// --- Cropper ---
const CROP_BOX = 220;
let cropState = { playerIdx: null, x: 0, y: 0, scale: 1, imgW: 0, imgH: 0 };
let _drag = null, _pinch = null;

function openCropper(playerIdx, src) {
  cropState.playerIdx = playerIdx;
  const img = document.getElementById('crop-img');
  img.onload = () => {
    cropState.imgW = img.naturalWidth;
    cropState.imgH = img.naturalHeight;
    img.style.width  = cropState.imgW + 'px';
    img.style.height = cropState.imgH + 'px';
    // Initial scale: fill the circle with the short side
    const minDim = Math.min(cropState.imgW, cropState.imgH);
    cropState.scale = CROP_BOX / minDim;
    cropState.x = (CROP_BOX - cropState.imgW * cropState.scale) / 2;
    cropState.y = (CROP_BOX - cropState.imgH * cropState.scale) / 2;
    updateCropTransform();
  };
  img.src = src;
  document.getElementById('crop-modal').classList.add('active');
}

function updateCropTransform() {
  const img = document.getElementById('crop-img');
  img.style.transform = `translate(${cropState.x}px,${cropState.y}px) scale(${cropState.scale})`;
}

function cropZoom(delta) {
  const newScale = Math.max(0.2, Math.min(10, cropState.scale * (1 + delta)));
  const f = newScale / cropState.scale;
  const cx = CROP_BOX / 2, cy = CROP_BOX / 2;
  cropState.x = cx - (cx - cropState.x) * f;
  cropState.y = cy - (cy - cropState.y) * f;
  cropState.scale = newScale;
  updateCropTransform();
}

function confirmCrop() {
  const canvas = document.createElement('canvas');
  canvas.width = canvas.height = CROP_BOX;
  const ctx = canvas.getContext('2d');
  ctx.beginPath();
  ctx.arc(CROP_BOX / 2, CROP_BOX / 2, CROP_BOX / 2, 0, Math.PI * 2);
  ctx.clip();
  const img = document.getElementById('crop-img');
  ctx.save();
  ctx.translate(cropState.x, cropState.y);
  ctx.scale(cropState.scale, cropState.scale);
  ctx.drawImage(img, 0, 0, cropState.imgW, cropState.imgH);
  ctx.restore();
  const dataUrl = canvas.toDataURL('image/jpeg', 0.88);
  const i = cropState.playerIdx;
  state.photos[i] = dataUrl;
  const av = document.getElementById('av' + i);
  if (av) av.innerHTML = `<img src="${dataUrl}" alt="">`;
  document.getElementById('crop-modal').classList.remove('active');
}

function cancelCrop() {
  document.getElementById('crop-modal').classList.remove('active');
}

function initCropEvents() {
  const el = document.getElementById('crop-container');

  // Touch â€” drag
  el.addEventListener('touchstart', e => {
    e.preventDefault();
    if (e.touches.length === 1) {
      _pinch = null;
      _drag = { sx: e.touches[0].clientX, sy: e.touches[0].clientY,
                ox: cropState.x, oy: cropState.y };
    } else if (e.touches.length === 2) {
      _drag = null;
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const rect = el.getBoundingClientRect();
      _pinch = {
        dist: Math.hypot(dx, dy),
        os: cropState.scale, ox: cropState.x, oy: cropState.y,
        mx: (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left,
        my: (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top,
      };
    }
  }, { passive: false });

  // Touch â€” move
  el.addEventListener('touchmove', e => {
    e.preventDefault();
    if (_drag && e.touches.length === 1) {
      cropState.x = _drag.ox + e.touches[0].clientX - _drag.sx;
      cropState.y = _drag.oy + e.touches[0].clientY - _drag.sy;
      updateCropTransform();
    } else if (_pinch && e.touches.length === 2) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const f = Math.hypot(dx, dy) / _pinch.dist;
      const newScale = Math.max(0.2, Math.min(10, _pinch.os * f));
      const sf = newScale / _pinch.os;
      cropState.scale = newScale;
      cropState.x = _pinch.mx - (_pinch.mx - _pinch.ox) * sf;
      cropState.y = _pinch.my - (_pinch.my - _pinch.oy) * sf;
      updateCropTransform();
    }
  }, { passive: false });

  el.addEventListener('touchend', e => {
    if (e.touches.length === 0) { _drag = null; _pinch = null; }
    else if (e.touches.length === 1) { _pinch = null; }
  });

  // Mouse (desktop)
  el.addEventListener('mousedown', e => {
    _drag = { sx: e.clientX, sy: e.clientY, ox: cropState.x, oy: cropState.y };
  });
  document.addEventListener('mousemove', e => {
    if (!_drag) return;
    cropState.x = _drag.ox + e.clientX - _drag.sx;
    cropState.y = _drag.oy + e.clientY - _drag.sy;
    updateCropTransform();
  });
  document.addEventListener('mouseup', () => { _drag = null; });
  el.addEventListener('wheel', e => {
    e.preventDefault();
    cropZoom(e.deltaY > 0 ? -0.08 : 0.08);
  }, { passive: false });
}

initCropEvents();

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
